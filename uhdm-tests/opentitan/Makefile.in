curr_dir:=$(dir $(lastword $(MAKEFILE_LIST)))
OPENTITAN = ${curr_dir}/opentitan

################################
#### verilator - simulation ####
################################
OPENTITAN_BUILD = ${root_dir}/build/lowrisc_systems_top_earlgrey_verilator_0.1

OPENTITAN_INCLUDE = \
	-I$(OPENTITAN_BUILD)/src/lowrisc_prim_assert_0.1/rtl \
	-I$(OPENTITAN_BUILD)/src/lowrisc_ibex_ibex_core_0.1/rtl \
	-I$(OPENTITAN_BUILD)/src/lowrisc_dv_dv_macros_0 \
	-I$(OPENTITAN_BUILD)/src/lowrisc_prim_util_memload_0/rtl

# Names of source files only read by Verilator (starting with / to avoid false matches by suffix)
VERILATOR_ONLY_SOURCE_FILENAMES=\
/uartdpi.sv \
/sw_test_status_if.sv \
/prim_generic_ram_1p.sv \
/prim_generic_rom.sv \
/pwrmgr_reg_top.sv \
/rstmgr_reg_top.sv \
/pinmux_reg_top.sv \
/prim_clock_mux2.sv \
/prim_ram_1p.sv \
/prim_rom.sv \
/ibex_icache.sv \
/prim_clock_gating_sync.sv \
/prim_arbiter_ppc.sv \
/prim_arbiter_tree.sv \
/prim_esc_receiver.sv \
/prim_sram_arbiter.sv \
/prim_fifo_async.sv \
/prim_sync_reqack.sv \
/prim_sync_reqack_data.sv \
/prim_keccak.sv \
/prim_packer.sv \
/prim_prince.sv \
/prim_subst_perm.sv \
/prim_filter.sv \
/prim_subreg_shadow.sv \
/prim_generic_clock_inv.sv \
/prim_lc_sender.sv \
/prim_lc_sync.sv \
/prim_ram_1p_adv.sv \
/prim_rom_adv.sv \
/ibex_core.sv \
/prim_clock_inv.sv \
/prim_edn_req.sv \
/prim_generic_otp.sv \
/prim_ram_1p_scr.sv \
/prim_ram_2p_adv.sv \
/tlul_fifo_sync.sv \
/tlul_fifo_async.sv \
/prim_otp.sv \
/flash_ctrl_reg_top.sv \
/flash_ctrl.sv \
/tlul_adapter_sram.sv \
/tlul_socket_1n.sv \
/tlul_socket_m1.sv \
/tlul_sink.sv \
/sim_sram_if.sv \
/sim_sram.sv \
/prim_clock_div.sv \
/dm_csrs.sv \
/dm_mem.sv \
/dmi_cdc.sv \
/dmi_jtag.sv \
/dmi_jtag_tap.sv \
/aes_reg_top.sv \
/aes_core.sv \
/aes_ctr.sv \
/aes_control.sv \
/aes_sel_buf_chk.sv \
/aes_cipher_core.sv \
/aes_cipher_control.sv \
/aes_sub_bytes.sv \
/aes_key_expand.sv \
/aes_prng_clearing.sv \
/aes_prng_masking.sv \
/aes.sv \
/edn_reg_top.sv \
/edn_ack_sm.sv \
/edn_main_sm.sv \
/edn_core.sv \
/edn.sv \
/gpio.sv \
/gpio_reg_top.sv \
/hmac_reg_top.sv \
/hmac.sv \
/i2c_reg_top.sv \
/i2c_core.sv \
/i2c.sv \
/keymgr_reg_top.sv \
/keymgr_ctrl.sv \
/keymgr_reseed_ctrl.sv \
/keymgr.sv \
/nmi_gen_reg_top.sv \
/nmi_gen.sv \
/otbn_controller.sv \
/otbn_rf_base.sv \
/otbn_loop_controller.sv \
/otbn_core.sv \
/otbn_reg_top.sv \
/otbn.sv \
/otp_ctrl_reg_top.sv \
/otp_ctrl_ecc_reg.sv \
/otp_ctrl_scrmbl.sv \
/otp_ctrl_lfsr_timer.sv \
/otp_ctrl_part_unbuf.sv \
/otp_ctrl_part_buf.sv \
/otp_ctrl_dai.sv \
/otp_ctrl_kdi.sv \
/otp_ctrl_lci.sv \
/otp_ctrl.sv \
/pattgen_reg_top.sv \
/pattgen_core.sv \
/pattgen.sv \
/pwrmgr.sv \
/pwrmgr_cdc.sv \
/pwrmgr_fsm.sv \
/rv_core_ibex.sv \
/rv_dm.sv \
/rv_plic_target.sv \
/rv_timer_reg_top.sv \
/rv_timer.sv \
/keccak_round.sv \
/keccak_2share.sv \
/sha3pad.sv \
/sha3.sv \
/spi_device_reg_top.sv \
/spi_device.sv \
/sram_ctrl_reg_top.sv \
/sram_ctrl.sv \
/uart_reg_top.sv \
/uart_core.sv \
/uart.sv \
/usbdev_reg_top.sv \
/usbdev_usbif.sv \
/usbdev_linkstate.sv \
/usbdev_iomux.sv \
/usbdev_aon_wake.sv \
/usbdev.sv \
/prim_generic_flash_bank.sv \
/prim_generic_flash.sv \
/clkmgr_reg_top.sv \
/clkmgr.sv \
/sensor_ctrl_reg_top.sv \
/xbar_main.sv \
/xbar_peri.sv \
/csrng_reg_top.sv \
/csrng_main_sm.sv \
/csrng_cmd_stage.sv \
/csrng_block_encrypt.sv \
/csrng_ctr_drbg_cmd.sv \
/csrng_ctr_drbg_upd.sv \
/csrng_ctr_drbg_gen.sv \
/csrng_core.sv \
/csrng.sv \
/kmac_core.sv \
/kmac_msgfifo.sv \
/kmac_staterd.sv \
/kmac_reg_top.sv \
/kmac.sv \
/lc_ctrl_reg_top.sv \
/lc_ctrl_signal_decode.sv \
/lc_ctrl_fsm.sv \
/lc_ctrl.sv \
/pinmux_wkup.sv \
/pinmux.sv \
/prim_flash.sv \
/rv_plic_reg_top.sv \
/rv_plic.sv \
/sensor_ctrl.sv \
/flash_ctrl_lcmgr.sv \
/flash_mp.sv \
/flash_mp_data_region_sel.sv \
/flash_phy.sv \
/flash_phy_core.sv \
/flash_phy_rd.sv \
/flash_phy_scramble.sv \
/rstmgr.sv \
/rstmgr_ctrl.sv \
/rstmgr_por.sv \
/rstmgr_crash_info.sv \
/top_earlgrey.sv \
/top_earlgrey_verilator.sv \

# Names of source files read by Verilator AND Surelog (starting with / to avoid false matches by suffix)
VERILATOR_AND_SURELOG_SOURCE_FILENAMES=\
/prim_generic_clock_gating.sv \
/prim_buf.sv \
/prim_diff_decode.sv \
/prim_subreg.sv \
/prim_subreg_arb.sv \
/prim_subreg_ext.sv \
/prim_intr_hw.sv \
/prim_lfsr.sv \
/prim_clock_gating.sv \
/prim_flop.sv \
/prim_generic_flop.sv \
/prim_flop_2sync.sv \
/prim_generic_flop_2sync.sv \
/prim_packer_fifo.sv \
/prim_alert_sender.sv \
/prim_alert_receiver.sv \
/prim_fifo_sync.sv \
/tlul_adapter_reg.sv

# Regexes for grep
VERILATOR_ONLY_REGEX=$(shell echo ${VERILATOR_ONLY_SOURCE_FILENAMES} | sed 's/\s/\\|/g')
VERILATOR_AND_SURELOG_REGEX=$(shell echo ${VERILATOR_AND_SURELOG_SOURCE_FILENAMES} | sed 's/\s/\\|/g')

# File containing OpenTitan source paths
VC_FILE=${OPENTITAN_BUILD}/sim-verilator/lowrisc_systems_top_earlgrey_verilator_0.1.vc

# Source paths read by Verilator (including those from VERILATOR_AND_SURELOG_SOURCE_FILENAMES)
VERILATOR_SOURCES=$(shell grep -F .sv < ${VC_FILE} | grep '${VERILATOR_ONLY_REGEX}\|${VERILATOR_AND_SURELOG_REGEX}')

# Source paths read by Surelog (including those from VERILATOR_AND_SURELOG_SOURCE_FILENAMES)
SURELOG_SOURCES=$(shell grep -F .sv < ${VC_FILE} | grep -v '${VERILATOR_ONLY_REGEX}' | sed 's@^..@${OPENTITAN_BUILD}@')

# Top-level parameters in skipped modules that need to be known to Surelog
SURELOG_PARAMETERS = -PPMPNumRegions=16 \
                       -PBranchTargetALU=1 \
                       -PWritebackStage=1 \
                      --disable-feature=parametersubstitution

CPU_COUNT = $(shell nproc)

prepare-sources:
	virtualenv ${root_dir}/venv-opentitan
	(export PATH=${root_dir}/../image/bin:${PATH} && \
		. ${root_dir}/venv-opentitan/bin/activate && \
		pip install -r ${OPENTITAN}/python-requirements.txt && \
		pip install git+https://github.com/antmicro/edalize@surelog && \
		fusesoc --cores-root=${OPENTITAN} run --flag=fileset_top --target=sim --setup lowrisc:systems:top_earlgrey_verilator \
		--verilator_options '--threads ${CPU_COUNT}')

uhdm/verilator/opentitan: clean-build | prepare-sources
	(export PATH=${root_dir}/../image/bin:${PATH} && \
		. ${root_dir}/venv-opentitan/bin/activate && \
		cd ${root_dir}/build && \
		${root_dir}/../image/bin/surelog -nobuiltin -parse -sverilog +define+VERILATOR \
			${SURELOG_PARAMETERS} \
			$(OPENTITAN_INCLUDE) \
			$(SURELOG_SOURCES) && \
		cp ${root_dir}/build/slpp_all/surelog.uhdm ${root_dir}/build/ibex_core.uhdm && \
		cd ${OPENTITAN_BUILD}/sim-verilator/ && \
		sed 's/-Wall -DVM_TRACE_FMT_FST/-DVM_TRACE_FMT_FST/g' -i config.mk && \
		sed '/--cc/a --uhdm-ast-sv' -i lowrisc_systems_top_earlgrey_verilator_0.1.vc && \
		sed '/--uhdm-ast-sv/a ${root_dir}/build/ibex_core.uhdm' -i lowrisc_systems_top_earlgrey_verilator_0.1.vc && \
		sed '/\.sv$$/d' -i lowrisc_systems_top_earlgrey_verilator_0.1.vc && \
		sed '/--top-module top_earlgrey_verilator/i ${VERILATOR_SOURCES}' -i lowrisc_systems_top_earlgrey_verilator_0.1.vc && \
		$(MAKE))

verilator/opentitan: clean-build | prepare-sources
	(export PATH=${root_dir}/../image/bin:${PATH} && \
		. ${root_dir}/venv-opentitan/bin/activate && \
		cd ${OPENTITAN_BUILD}/sim-verilator/ && \
		$(MAKE))
