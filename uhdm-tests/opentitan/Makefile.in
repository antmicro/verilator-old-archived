curr_dir:=$(dir $(lastword $(MAKEFILE_LIST)))
OPENTITAN = ${curr_dir}/opentitan
TOP_TARGET_NAME = chip_earlgrey_verilator

################################
#### verilator - simulation ####
################################
OPENTITAN_BUILD = ${root_dir}/build/lowrisc_systems_$(TOP_TARGET_NAME)_0.1

# Names of source files only read by Verilator (starting with / to avoid false matches by suffix)
VERILATOR_ONLY_SOURCE_FILENAMES=\

# Names of source files read by Verilator AND Surelog (starting with / to avoid false matches by suffix)
VERILATOR_AND_SURELOG_SOURCE_FILENAMES=\

# Regexes for grep
VERILATOR_ONLY_REGEX=$(shell echo ${VERILATOR_ONLY_SOURCE_FILENAMES} | sed 's/\s/\\|/g')
VERILATOR_AND_SURELOG_REGEX=$(shell echo ${VERILATOR_AND_SURELOG_SOURCE_FILENAMES} | sed 's/\s/\\|/g')

# File containing OpenTitan source paths
VC_FILE=${OPENTITAN_BUILD}/sim-verilator/lowrisc_systems_top_earlgrey_verilator_0.1.vc

# Source paths read by Verilator (including those from VERILATOR_AND_SURELOG_SOURCE_FILENAMES)
VERILATOR_SOURCES=$(shell grep -F .sv < ${VC_FILE} | grep '${VERILATOR_ONLY_REGEX}\|${VERILATOR_AND_SURELOG_REGEX}')

# Source paths read by Surelog (including those from VERILATOR_AND_SURELOG_SOURCE_FILENAMES)
SURELOG_SOURCES=$(shell grep -F .sv < ${VC_FILE} | grep -v '${VERILATOR_ONLY_REGEX}' | sed 's@^..@${OPENTITAN_BUILD}@')

OPENTITAN_INCLUDES=$(shell grep "\-CFLAGS \-I.." < ${VC_FILE} | sed 's@-CFLAGS -I..@-I${OPENTITAN_BUILD}@g')

SURELOG_DEFINES=$(shell grep "^-D" < ${VC_FILE})

# Top-level parameters in skipped modules that need to be known to Surelog
SURELOG_PARAMETERS = -PPMPNumRegions=16 \
                       -PBranchTargetALU=1 \
                       -PWritebackStage=1 \

CPU_COUNT = $(shell nproc)

prepare-sources:
	virtualenv ${root_dir}/venv-opentitan
	(export PATH=${root_dir}/../image/bin:${PATH} && \
		. ${root_dir}/venv-opentitan/bin/activate && \
		pip install -r ${OPENTITAN}/python-requirements.txt && \
		pip install git+https://github.com/antmicro/edalize@surelog && \
		fusesoc --cores-root=${OPENTITAN} run --flag=fileset_top --target=sim --setup lowrisc:systems:$(TOP_TARGET_NAME) \
		--verilator_options '--threads ${CPU_COUNT}')

uhdm/verilator/opentitan: clean-build | prepare-sources
	(export PATH=${root_dir}/../image/bin:${PATH} && \
		. ${root_dir}/venv-opentitan/bin/activate && \
		cd ${root_dir}/build && \
		${root_dir}/../image/bin/surelog -nobuiltin -parse -sverilog +define+VERILATOR \
			${SURELOG_PARAMETERS} \
			${SURELOG_DEFINES} \
			$(OPENTITAN_INCLUDES) \
			$(SURELOG_SOURCES) && \
		cp ${root_dir}/build/slpp_all/surelog.uhdm ${root_dir}/build/ibex_core.uhdm && \
		cd ${OPENTITAN_BUILD}/sim-verilator/ && \
		sed 's/-Wall -DVM_TRACE_FMT_FST/-DVM_TRACE_FMT_FST/g' -i config.mk && \
		sed '/--cc/a --uhdm-ast-sv' -i lowrisc_systems_$(TOP_TARGET_NAME)_0.1.vc && \
		sed '/--uhdm-ast-sv/a ${root_dir}/build/ibex_core.uhdm' -i lowrisc_systems_$(TOP_TARGET_NAME)_0.1.vc && \
		sed '/\.sv$$/d' -i lowrisc_systems_$(TOP_TARGET_NAME)_0.1.vc && \
		sed '/--top-module $(TOP_TARGET_NAME)/i ${VERILATOR_SOURCES}' -i lowrisc_systems_$(TOP_TARGET_NAME)_0.1.vc && \
		$(MAKE))

verilator/opentitan: clean-build | prepare-sources
	(export PATH=${root_dir}/../image/bin:${PATH} && \
		. ${root_dir}/venv-opentitan/bin/activate && \
		cd ${OPENTITAN_BUILD}/sim-verilator/ && \
		$(MAKE))
