curr_dir:=$(dir $(lastword $(MAKEFILE_LIST)))
OPEN_TITAN = ${curr_dir}/opentitan

################################
#### verilator - simulation ####
################################
OPEN_TITAN_BUILD = ${root_dir}/build/lowrisc_systems_top_earlgrey_verilator_0.1

OPEN_TITAN_INCLUDE = \
	-I$(OPEN_TITAN_BUILD)/src/lowrisc_prim_assert_0.1/rtl \
	#-I$(OPEN_TITAN_BUILD)/src/lowrisc_ibex_ibex_core_0.1/rtl \
	#-I$(OPEN_TITAN_BUILD)/src/lowrisc_dv_dv_macros_0 \
	#-I$(OPEN_TITAN_BUILD)/src/lowrisc_prim_util_memload_0/rtl

# Take Ibex Core source files
#TO_SURELOG='ibex_core.sv\|ibex_pkg.sv\|prim_clock_gating.sv\|prim_generic_clock_gating.sv\|ibex_if_stage.sv\|ibex_prefetch_buffer.sv\|ibex_compressed_decoder.sv\|ibex_fetch_fifo.sv\|ibex_id_stage.sv\|ibex_decoder.sv\|ibex_controller.sv\|ibex_ex_block.sv\|ibex_alu.sv\|ibex_multdiv_fast.sv\|ibex_load_store_unit.sv\|ibex_wb_stage.sv\|ibex_cs_registers.sv\|ibex_register_file_ff.sv\|ibex_csr.sv\|ibex_counter.sv\|ibex_icache.sv\|ibex_pmp.sv\|prim_secded_28_22_enc.sv\|prim_secded_72_64_enc.sv\|prim_ram_1p.sv\|prim_secded_28_22_dec.sv\|prim_secded_72_64_dec.sv\|prim_generic_ram_1p.sv\|prim_lfsr.sv\|ibex_dummy_instr.sv'
TO_SURELOG='ibex_load_store_unit.sv'

SKIP_SOURCES='rv_core_ibex_pkg.sv'

READD='../src/lowrisc_ip_rv_core_ibex_pkg_0.1/rtl/rv_core_ibex_pkg.sv'

# Top-level parameters in skipped modules that need to be known to Surelog
SURELOG_PARAMETERS = +define+RVFI +define+VERILATOR_TEST_STATUS_ADDR=805306368 \
			#-PPMPEnable=1 \
			#-PPMPGranularity=0 \
			#-PPMPNumRegions=16 \
			#-PMHPMCounterNum=10 \
			#-PMHPMCounterWidth=32 \
			#-PRV32E=0 \
			#-PRV32M=3 \
			#-PRV32B=0 \
			#-PRegFile=0 \
			#-PBranchTargetALU=1 \
			#-PWritebackStage=1 \
			#-PICache=1 \
			#-PICacheECC=1 \
			#-PBranchPredictor=0 \
			#-PDbgTriggerEn=1 \
			#-PSecureIbex=0 \
			#-PDmHaltAddr=437323776 \
			#-PDmExceptionAddr=437323784 \

OPEN_TITAN_SOURCES = \
	$(shell \
		cat ${OPEN_TITAN_BUILD}/sim-verilator/lowrisc_systems_top_earlgrey_verilator_0.1.vc | \
		grep -F .sv | grep ${TO_SURELOG} | grep -v ${SKIP_SOURCES} | \
		sed 's@^..@${OPEN_TITAN_BUILD}@')

OPEN_TITAN_SOURCES_DELETE = \
        $(shell \
                cat ${OPEN_TITAN_BUILD}/sim-verilator/lowrisc_systems_top_earlgrey_verilator_0.1.vc | \
		grep -F .sv | grep ${TO_SURELOG}  | grep -v ${SKIP_SOURCES} | sed "s/.*\///")

OPEN_TITAN_SOURCES_DELETE_OR = \
	$(shell \
		echo ${OPEN_TITAN_SOURCES_DELETE} | sed 's/\s/\\|/g')

CPU_COUNT = $(shell nproc)

prepare-sources:
	virtualenv ${root_dir}/venv-opentitan
	(export PATH=${root_dir}/../image/bin:${PATH} && \
		. ${root_dir}/venv-opentitan/bin/activate && \
		pip install -r ${OPEN_TITAN}/python-requirements.txt && \
		pip install git+https://github.com/antmicro/edalize@surelog && \
		fusesoc --cores-root=${OPEN_TITAN} run --flag=fileset_top --target=sim --setup lowrisc:systems:top_earlgrey_verilator \
		--verilator_options '--threads ${CPU_COUNT}')

uhdm/verilator/simple-system: clean-build | prepare-sources
	echo "TO_SURELOG"
	echo ${TO_SURELOG}
	echo
	echo "SKIP_SOURCES"
	echo ${SKIP_SOURCES}
	echo
	echo "OPEN_TITAN_SOURCES"
	echo ${OPEN_TITAN_SOURCES}
	echo
	echo "OPEN_TITAN_SOURCES_DELETE"
	echo ${OPEN_TITAN_SOURCES_DELETE}
	echo
	echo "OPEN_TITAN_SOURCES_DELETE_OR"
	echo ${OPEN_TITAN_SOURCES_DELETE_OR}
	echo
	(export PATH=${root_dir}/../image/bin:${PATH} && \
		. ${root_dir}/venv-opentitan/bin/activate && \
		cd ${root_dir}/build && \
		${root_dir}/../image/bin/surelog -nobuiltin -parse -sverilog +define+VERILATOR \
			${SURELOG_PARAMETERS} \
			$(OPEN_TITAN_INCLUDE) \
			$(OPEN_TITAN_SOURCES) && \
		cp ${root_dir}/build/slpp_all/surelog.uhdm ${root_dir}/build/ibex_core.uhdm && \
		cd ${OPEN_TITAN_BUILD}/sim-verilator/ && \
		sed 's/-Wall -DVM_TRACE_FMT_FST/-DVM_TRACE_FMT_FST/g' -i config.mk && \
		sed '/--cc/a --uhdm-ast-sv' -i lowrisc_systems_top_earlgrey_verilator_0.1.vc && \
		sed '/${OPEN_TITAN_SOURCES_DELETE_OR}/d' -i lowrisc_systems_top_earlgrey_verilator_0.1.vc && \
		#sed '/usbdev_pkg.sv/i ${READD}' -i lowrisc_systems_top_earlgrey_verilator_0.1.vc && \
		sed '/--top-module.*/i ${root_dir}/build/ibex_core.uhdm' -i lowrisc_systems_top_earlgrey_verilator_0.1.vc && \
		$(MAKE))
		#sed '/--top-module.*/i ${curr_dir}/simple_system.vlt ${root_dir}/build/simple_system.uhdm' -i lowrisc_systems_top_earlgrey_verilator_0.1.vc && \

verilator/simple-system: clean-build | prepare-sources
	(export PATH=${root_dir}/../image/bin:${PATH} && \
		. ${root_dir}/venv-opentitan/bin/activate && \
		cd ${OPEN_TITAN_BUILD}/sim-verilator/ && \
		$(MAKE))
